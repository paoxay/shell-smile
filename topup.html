<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ເຕີມເງິນ - Smile Panel</title>
    <style>
        /* CSS remains the same as the previous version */
        body { font-family: 'Noto Sans Lao', sans-serif; display: flex; justify-content: center; align-items: flex-start; background-color: #f0f2f5; padding-top: 50px; }
        .container { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 450px; }
        h2, h3 { text-align: center; color: #333; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 16px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .message { margin-top: 15px; text-align: center; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
        #payment-details-section { border-top: 1px solid #eee; margin-top: 30px; padding-top: 20px; }
        .detail-item { display: flex; flex-wrap: wrap; justify-content: space-between; margin-bottom: 12px; padding: 8px; background-color: #f9f9f9; border-radius: 4px;}
        .detail-item span:first-child { color: #555; font-weight: bold; }
        .detail-item span:last-child { font-weight: normal; word-break: break-all; text-align: right; }
    </style>
</head>
<body>
    <div class="container">
        <div id="initiate-section">
            <h2>ເຕີມເງິນ</h2>
            <form id="initiate-form">
                <div class="input-group">
                    <label for="amount">ຈຳນວນເງິນ ($):</label>
                    <input type="number" id="amount" name="amount" step="0.01" required placeholder="ຕົວຢ່າງ: 1">
                </div>
                <button type="submit">ສ້າງລາຍການເຕີມເງິນ</button>
            </form>
            <div id="initiate-message" class="message"></div>
        </div>

        <div id="payment-details-section" style="display: none;">
            <h3>ຂໍ້ມູນການຊຳລະເງິນ</h3>
            <p style="text-align: center; color: red;">ກະລຸນາໂອນເງິນຕາມລາຍລະອຽດລຸ່ມນີ້ໃຫ້ຄົບຖ້ວນ</p>
            <div class="detail-item"><span>ເລກອ້າງອີງ:</span> <span id="detail-ref"></span></div>
            <div class="detail-item"><span>ຈຳນວນທີ່ຕ້ອງໂອນ:</span> <span id="detail-amount"></span></div>
            <div class="detail-item"><span>ສະກຸນເງິນ:</span> <span id="detail-currency"></span></div>
            <div class="detail-item"><span>ເຄືອຂ່າຍ:</span> <span id="detail-network"></span></div>
            <div class="detail-item"><span>ທີ່ຢູ່ກະເປົາ (Address):</span> <span id="detail-wallet"></span></div>
            <hr>
            <p>ເມື່ອໂອນສຳເລັດ, ກະລຸນາໃສ່ເລກທຸລະກຳ (TxID) ໃນຊ່ອງລຸ່ມນີ້ເພື່ອຢືນຢັນ.</p>
        </div>
        
        <div id="confirm-section" style="display: none;">
             <form id="confirm-form">
                <div class="input-group">
                    <label for="txid">ເລກທຸລະກຳ (TxID):</label>
                    <input type="text" id="txid" name="txid" required>
                </div>
                <button type="submit">ຢືນຢັນການຊຳລະເງິນ</button>
            </form>
            <div id="confirm-message" class="message"></div>
        </div>
    </div>

    <script>
        const initiateSection = document.getElementById('initiate-section');
        const paymentSection = document.getElementById('payment-details-section');
        const confirmSection = document.getElementById('confirm-section');
        const initiateForm = document.getElementById('initiate-form');
        const confirmForm = document.getElementById('confirm-form');
        const initiateMessage = document.getElementById('initiate-message');
        const confirmMessage = document.getElementById('confirm-message');
        let currentRefCode = null;

        initiateForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const amount = document.getElementById('amount').value;
            
            if (!amount || amount <= 0) { /* ... Validation ... */ return; }

            initiateMessage.textContent = 'ກຳລັງສ້າງລາຍການ...';
            
            fetch('api/topup/initiate.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: parseFloat(amount) })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    currentRefCode = result.data.ref;
                    
                    // --- ສ່ວນທີ່ອັບເດດ ---
                    // ນຳຂໍ້ມູນທີ່ໄດ້ຮັບມາໃໝ່ມາສະແດງຜົນ
                    document.getElementById('detail-ref').textContent = result.data.ref;
                    document.getElementById('detail-amount').textContent = `$${result.data.amount}`;
                    document.getElementById('detail-currency').textContent = result.data.payment_details.currency;
                    document.getElementById('detail-network').textContent = result.data.payment_details.network;
                    document.getElementById('detail-wallet').textContent = result.data.payment_details.wallet_address;
                    
                    initiateSection.style.display = 'none';
                    paymentSection.style.display = 'block';
                    confirmSection.style.display = 'block';
                } else {
                    initiateMessage.className = 'message error';
                    initiateMessage.textContent = result.message || 'ເກີດຂໍ້ຜິດພາດ';
                }
            })
            .catch(err => {
                initiateMessage.className = 'message error';
                initiateMessage.textContent = 'ເກີດຂໍ້ຜິດພາດໃນການເຊື່ອມຕໍ່.';
            });
        });

        // Event listener for confirm form remains the same
        confirmForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const txId = document.getElementById('txid').value;
            if (!txId) { /* ... Validation ... */ return; }

            confirmMessage.textContent = 'ກຳລັງຢືນຢັນ...';

            fetch('api/topup/confirm.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ref: currentRefCode, txId: txId })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    confirmMessage.className = 'message success';
                    confirmMessage.textContent = result.message;
                    confirmSection.style.display = 'none';
                    paymentSection.querySelector('p:last-of-type').style.display = 'none'; // ເຊື່ອງຂໍ້ຄວາມ "ເມື່ອໂອນສຳເລັດ..."
                } else {
                    confirmMessage.className = 'message error';
                    confirmMessage.textContent = result.message;
                }
            })
            .catch(err => {
                confirmMessage.className = 'message error';
                confirmMessage.textContent = 'ເກີດຂໍ້ຜິດພາດໃນການເຊື່ອມຕໍ່.';
            });
        });
    </script>
</body>
</html>