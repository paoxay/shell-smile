<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ລາຍລະອຽດສິນຄ້າ</title>
    <style>
        /* CSS ຍັງຄືເກົ່າ */
        body { font-family: 'Noto Sans Lao', sans-serif; background-color: #f0f2f5; margin: 0; padding: 30px; }
        .container { background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        h2 { text-align: center; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f7f7f7; }
        .quantity-selector { display: flex; align-items: center; justify-content: center; }
        .quantity-selector button { width: 30px; height: 30px; border: 1px solid #ddd; background-color: #f9f9f9; cursor: pointer; font-size: 18px; }
        .quantity-selector input { width: 50px; text-align: center; border: 1px solid #ddd; border-left: none; border-right: none; height: 28px; }
        .summary { margin-top: 30px; border-top: 2px solid #007bff; padding-top: 20px; text-align: right; }
        .summary h3 { margin: 0; font-size: 24px; }
        .order-button { background-color: #28a745; color: white; padding: 12px 25px; font-size: 18px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }
        .order-button:hover { background-color: #218838; }
        .order-button:disabled { background-color: #aaa; cursor: not-allowed; }
        #message, #order-result { text-align: center; margin-top: 20px; font-size: 16px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="product-name">ກຳລັງໂຫຼດ...</h2>
        <div id="message"></div>
        <table id="items-table" style="display:none;">
            <thead>
                <tr>
                    <th>ແພັກເກັດ</th>
                    <th style="text-align: right;">ລາຄາ (USD)</th>
                    <th style="text-align: center;">ຈຳນວນ</th>
                </tr>
            </thead>
            <tbody id="items-table-body"></tbody>
        </table>
        <div class="summary" style="display:none;">
            <h3>ຍອດລວມ: <span id="total-price">$0.0000</span></h3>
            <button id="order-button" class="order-button">ສັ່ງຊື້</button>
        </div>
        <div id="order-result"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... (ຕົວແປ ແລະ ການດຶງ ID ສິນຄ້າຈາກ URL ຍັງຄືເກົ່າ) ...
            const messageDiv = document.getElementById('message');
            const productNameH2 = document.getElementById('product-name');
            const itemsTable = document.getElementById('items-table');
            const tableBody = document.getElementById('items-table-body');
            const summaryDiv = document.querySelector('.summary');
            const totalPriceSpan = document.getElementById('total-price');
            const orderButton = document.getElementById('order-button');
            const orderResultDiv = document.getElementById('order-result');
            
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) { /* ... Error handling ... */ return; }

            // ... (ໂຄດ fetch ເພື່ອດຶງລາຍລະອຽດສິນຄ້າຍັງຄືເກົ່າ) ...
            fetch(`api/store/detail.php?id=${productId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.items.length > 0) {
                        messageDiv.style.display = 'none';
                        itemsTable.style.display = 'table';
                        summaryDiv.style.display = 'block';
                        result.items.forEach(item => {
                            const row = document.createElement('tr');
                            row.dataset.itemId = item.item_id;
                            row.dataset.itemPid = item.item_pid; // ເພີ່ມການເກັບ Pid
                            row.dataset.price = item.base_price;
                            row.innerHTML = `
                                <td>${item.name}</td>
                                <td style="text-align: right;">$${item.base_price.toFixed(4)}</td>
                                <td style="text-align: center;">
                                    <div class="quantity-selector">
                                        <button class="btn-decrement">-</button>
                                        <input type="number" class="quantity-input" value="0" min="0">
                                        <button class="btn-increment">+</button>
                                    </div>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    } else { /* ... Error handling ... */ }
                });

            // ... (ໂຄດ event listener ຂອງປຸ່ມ + ແລະ - ຍັງຄືເກົ່າ) ...
            tableBody.addEventListener('click', function(event) {
                const target = event.target;
                const input = target.parentElement.querySelector('.quantity-input');
                if (!input) return;
                let currentValue = parseInt(input.value);
                if (target.classList.contains('btn-increment')) {
                    input.value = currentValue + 1;
                } else if (target.classList.contains('btn-decrement') && currentValue > 0) {
                    input.value = currentValue - 1;
                }
                updateTotal();
            });

            function updateTotal() { /* ... No changes ... */ 
                let total = 0;
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const price = parseFloat(row.dataset.price);
                    const quantity = parseInt(row.querySelector('.quantity-input').value);
                    total += price * quantity;
                });
                totalPriceSpan.textContent = `$${total.toFixed(4)}`;
            }

            // --- ສ່ວນທີ່ອັບເດດ: ຟັງຊັນຂອງປຸ່ມ "ສັ່ງຊື້" ---
            orderButton.addEventListener('click', function() {
                orderButton.disabled = true; // ປິດປຸ່ມຊົ່ວຄາວ
                orderButton.textContent = 'ກຳລັງປະມວນຜົນ...';
                orderResultDiv.innerHTML = '';

                // 1. ລວບລວມລາຍການສິນຄ້າທີ່ເລືອກ (ຈຳນວນ > 0)
                const itemsToOrder = [];
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const quantity = parseInt(row.querySelector('.quantity-input').value);
                    if (quantity > 0) {
                        itemsToOrder.push({
                            itemId: row.dataset.itemId,
                            quantity: quantity
                        });
                    }
                });

                if (itemsToOrder.length === 0) {
                    orderResultDiv.className = 'error';
                    orderResultDiv.textContent = 'ກະລຸນາເລືອກຈຳນວນສິນຄ້າຢ່າງໜ້ອຍ 1 ລາຍການ.';
                    orderButton.disabled = false;
                    orderButton.textContent = 'ສັ່ງຊື້';
                    return;
                }

                // 2. ສົ່ງຂໍ້ມູນໄປທີ່ API order.php
                fetch('api/store/order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: productId, // ສົ່ງ ID ຂອງໝວດສິນຄ້າໃຫຍ່ໄປນຳ
                        items: itemsToOrder
                    })
                })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        // ຖ້າການສັ່ງຊື້ສຳເລັດ
                        orderResultDiv.className = 'success';
                        let resultHTML = `<strong>${result.message}</strong><br>Ref: ${result.data.ref}<br>`;
                        
                        // ສະແດງ Voucher Code (ຖ້າມີ)
                        if(result.data.items && result.data.items.length > 0) {
                            result.data.items.forEach(item => {
                                if(item.codes && item.codes.length > 0) {
                                    resultHTML += `Voucher Code: <strong>${item.codes.join(', ')}</strong><br>`;
                                }
                            });
                        }
                        orderResultDiv.innerHTML = resultHTML;
                        summaryDiv.style.display = 'none'; // ເຊື່ອງປຸ່ມສັ່ງຊື້ ແລະ ຍອດລວມ

                    } else {
                        // ຖ້າການສັ່ງຊື້ລົ້ມເຫຼວ (ເຊັ່ນ ຍອດເງິນບໍ່ພໍ)
                        orderResultDiv.className = 'error';
                        orderResultDiv.textContent = result.message;
                        orderButton.disabled = false;
                        orderButton.textContent = 'ສັ່ງຊື້';
                    }
                })
                .catch(err => {
                    orderResultDiv.className = 'error';
                    orderResultDiv.textContent = 'ເກີດຂໍ້ຜິດພາດໃນການເຊື່ອມຕໍ່.';
                    orderButton.disabled = false;
                    orderButton.textContent = 'ສັ່ງຊື້';
                });
            });
        });
    </script>
</body>
</html>